# Документация экранов приложения LMS Augmentek

**Обновлено:** 24 июня 2024  
**Статус:** Все основные экраны реализованы и протестированы ✅  
**URL:** https://augmentek-lms.web.app

## Архитектура навигации

Приложение использует **роль-адаптивную табовую навигацию**:
- **Студенты:** Главная, Курсы (2 таба)
- **Администраторы:** Главная, Курсы, Админ (3 таба)
- **Профиль:** Клик на аватар в AppBar открывает профиль
- **Без logout:** Аутентификация привязана к Telegram профилю

## Дизайн система

### Цветовая схема
- **Основной:** Фиолетово-синяя палитра с градиентами
- **Акцент:** Оранжевые элементы для статусов и кнопок
- **Фон:** Белый с цветными карточками
- **Тема:** Material 3 с кастомной цветовой схемой

### Компоненты
- **Аватары:** Круглые с fallback на инициалы
- **Карточки:** Компактные 56x56px для курсов, расширенные для пользователей
- **Градиенты:** В welcome карточках и заголовках
- **Debug панель:** Плавающая иконка с количеством логов

## Структура экранов

### 1. Экран входа (LoginScreen) ✅
**Путь:** `/login`  
**Компонент:** `lib/features/auth/screens/login_screen.dart`  
**Статус:** Полностью реализован

**Описание:** 
- Автоматическая аутентификация через Telegram WebApp
- Loading индикатор с анимацией
- Обработка ошибок с понятными сообщениями

**Логика аутентификации:**
1. Получение данных от Telegram WebApp
2. Отправка в Firebase Functions для валидации
3. Получение custom token
4. Вход в Firebase Auth
5. Сохранение/загрузка профиля в Firestore

**Переходы:**
- ✅ Успешная аутентификация → Главная страница (`/`)
- ❌ Неизвестный пользователь → Сообщение "похоже, мы еще не знакомы. Напиши @nordansicht чтобы тебя добавили"
- ❌ Ошибка сети → Повторная попытка

### 2. Главная страница (HomeScreen) ✅
**Путь:** `/`  
**Компонент:** `lib/features/home/presentation/screens/home_screen.dart`  
**Статус:** Полностью реализован

**Описание:**
- Основной контейнер с IndexedStack навигацией
- AppBar с профилем пользователя (клик на аватар)
- BottomNavigationBar адаптируется к роли пользователя
- Плавающая debug панель (справа сверху)

**Структура:**
```
AppBar
├── Заголовок: "LMS Augmentek"
├── Actions: Аватар пользователя (клик → профиль)
└── Debug иконка (плавающая, справа сверху)

IndexedStack (переключение без пересоздания)
├── [0] StudentDashboard - для всех
├── [1] CourseListScreen - для всех  
└── [2] AdminDashboard - только для админов

BottomNavigationBar (адаптивный)
├── Таб 0: "Главная" (всегда)
├── Таб 1: "Курсы" (всегда)
└── Таб 2: "Админ" (только если user.isAdmin == true)
```

**Особенности:**
- Нет возможности logout (привязка к Telegram)
- Состояние табов сохраняется при переключении
- Аватары с graceful fallback на инициалы

### 3. Панель студента (StudentDashboard) ✅
**Путь:** `/` (таб 0)  
**Компонент:** `lib/features/student/presentation/screens/student_dashboard.dart`  
**Статус:** Полностью реализован

**Описание:**
- Welcome карточка с градиентом и реальным аватаром
- Статистические карточки (курсы, в процессе, завершено)
- Горизонтальный список популярных активных курсов

**Элементы:**
- **Welcome Card:** 
  - Градиентный фон (фиолетово-синий)
  - Аватар пользователя (круглый, 60px)
  - Приветствие с именем
  - Статус "Администратор" (если применимо)
- **Stats Row:** 3 карточки со статистикой
  - Курсы (общее количество активных)
  - В процессе (TODO: реальное отслеживание)
  - Завершено (TODO: реальное отслеживание)
- **Popular Courses:** 
  - Горизонтальный скролл (максимум 5 курсов)
  - Компактные карточки 280x200px
  - Показываются только активные курсы

**Взаимодействия:**
- Клик на курс → TODO: переход на детали курса
- "Смотреть все" → TODO: переход к полному списку курсов

### 4. Список курсов (CourseListScreen) ✅
**Путь:** `/` (таб 1)  
**Компонент:** `lib/features/course/presentation/screens/course_list_screen.dart`  
**Статус:** Полностью реализован

**Описание:**
- Поиск по названию и описанию курсов в реальном времени
- Вертикальный список с компактными карточками
- Pull-to-refresh для обновления
- Показывает только активные курсы для студентов

**Элементы:**
- **Search Bar:** Мгновенная фильтрация при вводе
- **Course Cards (компактные):**
  - Иконка/обложка 56x56px слева
  - Название курса и краткое описание справа
  - Статус курса (активный/неактивный)
  - Action кнопки для взаимодействия

**Фильтрация:**
- Студенты видят только активные курсы (`isActive: true`)
- Админы в этом экране тоже видят только активные
- Поиск работает по title и description

**Взаимодействия:**
- Ввод в поиск → Мгновенная фильтрация
- Pull-to-refresh → Перезагрузка курсов
- Клик на курс → TODO: переход на детали курса

### 5. Админ панель (AdminDashboard) ✅
**Путь:** `/` (таб 2) - только для админов  
**Компонент:** `lib/features/admin/presentation/screens/admin_dashboard.dart`  
**Статус:** Полностью реализован

**Описание:**
- Главный hub для управления LMS
- TabBar с двумя основными разделами
- Полный доступ ко всем функциям админа

**Структура:**
```
AppBar
├── Title: "Админ панель"
└── Actions: Debug иконка

TabBar
├── Таб "Управление курсами" → CourseManagementScreen
└── Таб "Пользователи" → UserListScreen
```

#### 5.1 Управление курсами (CourseManagementScreen) ✅

**Компонент:** `lib/features/admin/presentation/screens/course_management_screen.dart`

**Элементы:**
- **Floating Action Button:** "+" для создания нового курса
- **Список всех курсов:** Компактные карточки с полным функционалом
- **Фильтр по статусу:** Все, Активные, Неактивные

**Функции курса:**
- ✅ Создание через диалог (название, описание, обложка)
- ✅ Редактирование всех полей
- ✅ Удаление с подтверждением
- ✅ Изменение статуса (активный/неактивный)
- ✅ Загрузка обложек (URL + drag&drop виджет)

**Взаимодействия:**
- Клик на "+" → CreateCourseDialog
- Клик на карточку → Меню редактирования
- Свайп/долгое нажатие → Опции удаления

#### 5.2 Список пользователей (UserListScreen) ✅

**Компонент:** `lib/features/admin/presentation/screens/user_list_screen.dart`

**Элементы:**
- **Поиск пользователей:** По имени и username
- **Список пользователей:** Карточки с полной информацией
- **Фильтр по роли:** Все, Админы, Студенты

**Информация в карточке:**
- Аватар (круглый, с fallback на инициалы)
- Полное имя и @username
- Telegram ID
- Статус администратора (визуальный индикатор)
- Дата регистрации

**Взаимодействия:**
- Клик на пользователя → UserProfileScreen
- Поиск → Мгновенная фильтрация

### 6. Профиль пользователя (UserProfileScreen) ✅
**Путь:** Модальный переход из списка пользователей  
**Компонент:** `lib/features/admin/presentation/screens/user_profile_screen.dart`  
**Статус:** Полностью реализован

**Описание:**
- Детальная информация о выбранном пользователе
- Просмотр всех данных профиля
- Возможность возврата в список

**Элементы:**
- **Header:** Большой аватар (80px) с именем
- **Информация:**
  - Полное имя (имя + фамилия)
  - Username с @ префиксом
  - Telegram ID в отдельном блоке
  - Статус администратора (если применимо)
- **Действия:** Кнопка "Назад"

### 7. Диалоги и модальные окна ✅

#### 7.1 Создание курса (CreateCourseDialog) ✅
**Компонент:** `lib/features/admin/presentation/widgets/create_course_dialog.dart`

**Функционал:**
- Форма с валидацией полей
- Загрузка обложки (URL input + drag&drop)
- Переключатель статуса (активный/неактивный)
- Предпросмотр изображения

#### 7.2 Профиль в AppBar ✅
**Компонент:** Встроен в `home_screen.dart`

**Показывает:**
- Большой аватар (80px)
- Полная информация профиля
- Статус администратора
- Telegram ID

### 8. Debug панель (DebugLogScreen) ✅
**Компонент:** `lib/shared/widgets/debug_log_screen.dart`  
**Статус:** Полностью реализован

**Описание:**
- Плавающая иконка справа сверху (48x48px)
- Красный badge с количеством логов
- Полноэкранный overlay при клике
- Долгое нажатие скрывает иконку

**Функции:**
- Просмотр всех debug логов
- Автоматическая прокрутка к новым логам
- Цветная подсветка разных типов событий
- Возможность скрыть панель

## Технические решения

### ✅ Проблемы и их решения

#### Удаление курсов (РЕШЕНО)
**Была проблема:** Зависание при удалении с ошибкой "нет прав администратора"
**Решение:** 
- Создана отдельная коллекция `admins` в Firestore
- Обновлены правила безопасности для проверки по Firebase Auth UID
- Автоматическое создание admin документа при регистрации

#### Аватары от Telegram (ЧАСТИЧНО РЕШЕНО)
**Проблема:** SVG аватары не отображаются из-за CORS
**Решение:** 
- Graceful fallback на инициалы через errorBuilder
- Loading states при загрузке
- ClipOval для правильного отображения круглых аватаров

#### Загрузка изображений (ДОКУМЕНТИРОВАНО)
**Проблема:** FilePicker не работает в Telegram WebApp
**Текущее решение:** URL input с fallback
**Будущее решение:** Интеграция с Telegram Bot API

### Навигационные переходы

**Реализованные:**
- ✅ Вход → Главная
- ✅ Табы на главной странице (с сохранением состояния)
- ✅ Админ панель → Профиль пользователя
- ✅ AppBar аватар → Профиль текущего пользователя
- ✅ Админ табы → Управление курсами/пользователями

**TODO (планируется в следующих версиях):**
- ❌ Курсы → Детали курса с уроками
- ❌ Детали курса → Просмотр урока
- ❌ Система прогресса обучения

## Статистика реализации

### ✅ Полностью готовые экраны
- LoginScreen - аутентификация
- HomeScreen - навигация
- StudentDashboard - главная для студентов
- CourseListScreen - список курсов
- AdminDashboard - админ панель
- CourseManagementScreen - управление курсами
- UserListScreen - список пользователей  
- UserProfileScreen - профиль пользователя

### ✅ Реализованные компоненты
- CreateCourseDialog - создание курса
- CourseCard - карточка курса (компактная)
- UserCard - карточка пользователя
- ImageUploadWidget - загрузка изображений
- DebugLogScreen - отладочная панель

### ⏳ Планируемые экраны
- CourseDetailsScreen - детали курса с уроками
- LessonViewScreen - просмотр урока
- ProgressScreen - прогресс обучения
- TestScreen - тестирование знаний

**Общий прогресс:** 8/12 экранов готовы (67% завершено)

## Проблемы и их решения

### 🚨 КРИТИЧЕСКАЯ ПРОБЛЕМА: Удаление курсов [РЕШЕНО]
**Симптомы:** 
- Зависание при попытке удалить курс
- Сообщение "у вас нет прав администратора"

**Причина:**
Проблема была в правилах Firestore. Функция `isAdmin()` пыталась найти документ пользователя используя `request.auth.uid` (Firebase Auth UID), но мы используем Telegram ID как ключ документа в коллекции `users`.

**Решение:**
1. ✅ Изменили функцию `isAdmin()` в `firestore.rules` для использования специальной коллекции `admins`
2. ✅ Обновили `UserRepository` для создания документа в коллекции `admins` при создании пользователя-администратора
3. ✅ Исправили путь к урокам в правилах: `/lessons/{lessonId}` вместо `/courses/{courseId}/lessons/{lessonId}`

**Новая структура проверки прав:**
```javascript
function isAdmin() {
  return request.auth != null && 
    exists(/databases/$(database)/documents/admins/$(request.auth.uid));
}
```

**Структура данных:**
- Коллекция `users`: документы с ключом = Telegram ID
- Коллекция `admins`: документы с ключом = Firebase Auth UID, содержащие Telegram ID

**Статус:** ✅ ИСПРАВЛЕНО

### 🔄 Навигационные переходы

**Реализованные:**
- ✅ Вход → Главная
- ✅ Табы на главной странице
- ✅ Админ панель → Профиль пользователя
- ✅ Любой экран → Выход из аккаунта
- ✅ Админ панель → Назад на главную (таб 0)

**TODO (не реализовано):**
- ❌ Курсы → Детали курса
- ❌ Главная → Детали курса  
- ❌ Редактирование курса
- ❌ Создание уроков

## Права доступа

### Администратор (isAdmin: true)
- Доступ ко всем экранам
- ✅ Управление курсами (создание, редактирование, удаление)
- Просмотр списка пользователей
- Доступ к профилям других пользователей

### Обычный пользователь (isAdmin: false)
- Главная страница (панель студента)
- Список курсов с фильтрацией
- Детали курсов (просмотр)
- НЕТ доступа к админ панели

## Состояния загрузки

Все экраны корректно обрабатывают:
- ✅ Loading state (CircularProgressIndicator)
- ✅ Error state (Иконка ошибки + текст + кнопка повтора)
- ✅ Empty state (Заглушка с иконкой и текстом)
- ✅ Success state (Отображение данных)

## Настройки аутентификации

**Админ ID:** `142170313` (Telegram ID для пользователя "Pion")  
**Файл конфигурации:** `lib/core/config/admin_config.dart`

**Логика определения админа:**
1. Проверка Telegram ID в `AdminConfig.adminTelegramIds`
2. Установка флага `isAdmin: true` при создании пользователя
3. Сохранение в Firestore коллекции `users` (ключ = Telegram ID)
4. Создание документа в коллекции `admins` (ключ = Firebase Auth UID) для правил безопасности 